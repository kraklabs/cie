# Copyright 2024-2025 KrakLabs
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

# docker-compose.yml
# Local development environment for CIE - Code Intelligence Engine
#
# Usage:
#   docker-compose up -d                    # Start services
#   docker-compose --profile setup up       # First run: pull embedding model
#   docker-compose --profile dev up -d      # Start with shell access
#   docker-compose logs -f cie              # View CIE logs
#   docker-compose down                     # Stop services
#   docker-compose down -v                  # Stop and remove all data

version: "3.8"

services:
  # ==========================================================================
  # Ollama - Local LLM for embeddings
  # ==========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: cie-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - cie-network
    restart: unless-stopped

  # ==========================================================================
  # Ollama Model Pull (run once with --profile setup)
  # ==========================================================================
  ollama-setup:
    image: curlimages/curl:latest
    container_name: cie-ollama-setup
    depends_on:
      ollama:
        condition: service_healthy
    networks:
      - cie-network
    command: >
      sh -c "
        echo 'Pulling nomic-embed-text model...' &&
        curl -X POST http://ollama:11434/api/pull -d '{\"name\": \"nomic-embed-text\"}' &&
        echo 'Model ready!'
      "
    profiles:
      - setup

  # ==========================================================================
  # CIE - Code Intelligence Engine
  # ==========================================================================
  cie:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: dev
    image: cie:dev
    container_name: cie-dev
    volumes:
      # Mount repository for indexing (read-only for safety)
      - .:/repo:ro
      # Persist CIE data between runs
      - cie-data:/home/cie/.cie
    environment:
      OLLAMA_HOST: http://ollama:11434
      OLLAMA_EMBED_MODEL: nomic-embed-text
    depends_on:
      ollama:
        condition: service_healthy
    networks:
      - cie-network
    working_dir: /repo
    # Default command shows status
    command: ["status"]
    profiles:
      - tools

  # ==========================================================================
  # CIE Shell (for interactive development)
  # ==========================================================================
  cie-shell:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    image: cie:dev-builder
    container_name: cie-shell
    volumes:
      - .:/repo
      - cie-data:/home/cie/.cie
    environment:
      OLLAMA_HOST: http://ollama:11434
      OLLAMA_EMBED_MODEL: nomic-embed-text
    depends_on:
      ollama:
        condition: service_healthy
    networks:
      - cie-network
    working_dir: /repo
    entrypoint: ["/bin/bash"]
    stdin_open: true
    tty: true
    profiles:
      - dev

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  ollama-data:
    name: cie-ollama-data
  cie-data:
    name: cie-dev-data

# ==========================================================================
# Networks
# ==========================================================================
networks:
  cie-network:
    name: cie-dev-network
    driver: bridge
