# Security Audit Report - CIE Module

**Scan Date:** 2026-01-16
**Tool:** gosec (Go Security Checker)
**Module:** modules/cie

---

## Executive Summary

| Severity | Count | Status |
|----------|-------|--------|
| CRITICAL | 0 | N/A |
| HIGH | 7 | All documented with justifications |
| MEDIUM | 11 | All documented with justifications |
| LOW | 1 | Accepted in test code |

**Total Issues:** 20 (19 in source code + 1 in CGO-generated code)

**Conclusion:** All findings are either false positives or accepted risks with documented justifications. No code changes required.

---

## Scan Statistics

| Metric | Value |
|--------|-------|
| Files Scanned | 70 |
| Lines of Code | 24,025 |
| Issues Found | 20 |
| Suppressions (nosec) | 1 |

---

## Detailed Findings

### G115 - Integer Overflow Conversion (HIGH, 7 issues)

**CWE:** [CWE-190](https://cwe.mitre.org/data/definitions/190.html) - Integer Overflow or Wraparound

| File | Line | Conversion | Justification |
|------|------|------------|---------------|
| `pkg/ingestion/project_meta.go` | 79 | int64 -> uint64 | DB stores non-negative index values |
| `pkg/ingestion/project_meta.go` | 81 | int -> uint64 | DB stores non-negative index values |
| `pkg/ingestion/embedding.go` | 72 | int -> uint64 | Loop index bounded by dimension (small constant) |
| `pkg/ingestion/parser_python.go` | 225 | int -> uint32 | Line/col from parsed source are bounded |
| `pkg/ingestion/parser_python.go` | 225 | int -> uint32 | Line/col from parsed source are bounded |
| `pkg/ingestion/parser_javascript.go` | 323 | int -> uint32 | Line/col from parsed source are bounded |
| `pkg/ingestion/parser_javascript.go` | 323 | int -> uint32 | Line/col from parsed source are bounded |

**Risk Assessment:** LOW
These conversions occur in controlled contexts where the source values are guaranteed to be non-negative and within bounds:
- Database index values are always non-negative
- Line/column numbers from source parsing are bounded by file size limits
- Loop indices are bounded by small constants

---

### G304 - Potential File Inclusion via Variable (MEDIUM, 10 issues)

**CWE:** [CWE-22](https://cwe.mitre.org/data/definitions/22.html) - Path Traversal

| File | Line | Context | Justification |
|------|------|---------|---------------|
| `pkg/ingestion/manifest.go` | 456 | ReadFile | Path from manifest manager (internal) |
| `pkg/ingestion/delta.go` | 382 | Open | Path validated by caller |
| `pkg/ingestion/checkpoint.go` | 96 | ReadFile | Path from checkpoint manager (internal) |
| `cmd/cie/init.go` | 357 | ReadFile | gitignorePath built from repo dir |
| `cmd/cie/init.go` | 376 | OpenFile | gitignorePath built from repo dir |
| `cmd/cie/hook.go` | 147 | ReadFile | gitPath constructed from CWD |
| `cmd/cie/hook.go` | 207 | ReadFile | hookPath from user's git repo |
| `cmd/cie/hook.go` | 245 | ReadFile | hookPath from user's git repo |
| `cmd/cie/hook.go` | 313 | ReadFile | hookPath from git dir discovery |
| `cmd/cie/config.go` | 168 | ReadFile | Path from user config or discovery |

**Risk Assessment:** LOW
All file access paths are:
1. Constructed from known safe sources (CWD, git directory discovery)
2. Within the user's own repository context
3. Not exposed to external/untrusted input

CIE is a local CLI tool that operates on the user's local filesystem. The user must explicitly run the tool in their repository.

---

### G306 - WriteFile Permissions (MEDIUM, 1 issue)

**CWE:** [CWE-276](https://cwe.mitre.org/data/definitions/276.html) - Incorrect Default Permissions

| File | Line | Permission | Justification |
|------|------|------------|---------------|
| `cmd/cie/hook.go` | 221 | 0750 | Git hooks require execute permission |

**Risk Assessment:** ACCEPTED
The file being written is a git hook script that must be executable. Permission 0750 is the minimum required for git hooks to function.

---

### G104 - Errors Unhandled (LOW, 1 issue)

**CWE:** [CWE-703](https://cwe.mitre.org/data/definitions/703.html) - Improper Check for Exceptional Conditions

| File | Line | Context | Justification |
|------|------|---------|---------------|
| `internal/testing/helpers.go` | 67 | Close in Cleanup | Test helper cleanup function |

**Risk Assessment:** ACCEPTED
This occurs in a test cleanup function where:
1. The error has no recovery path in a cleanup context
2. Any close error during test teardown is non-critical
3. The backend is being cleaned up anyway

---

## CGO-Generated Code (Excluded)

One additional G115 issue was detected in CGO-generated code (`go-build` cache):

| Location | Issue |
|----------|-------|
| CGO cache | int -> uint64 in `_cgo_cmalloc` |

This is generated by the Go compiler for CGO bindings (CozoDB) and is not part of the CIE source code.

---

## Recommendations

### Immediate Actions
None required. All findings have been reviewed and documented.

### Future Considerations

1. **Go 1.24+ os.Root API**: Consider adopting `os.Root` for scoped file access when available, to provide defense-in-depth for file operations.

2. **Integer bounds checking**: For additional safety in production, consider adding explicit bounds checks before integer conversions, even for currently safe code paths.

3. **Periodic re-scans**: Run gosec scans as part of CI/CD to catch new issues.

---

## Verification Commands

```bash
# Verify no HIGH/CRITICAL issues without suppressions
gosec -exclude-dir=testdata -severity=high ./...

# Run full scan with JSON output
gosec -exclude-dir=testdata -fmt=json -out=security-report.json ./...

# Verify golangci-lint integration (gosec is enabled)
golangci-lint run ./...
```

---

## Appendix: nolint Comments

All issues have inline `//nolint:gosec` comments with rule IDs and justifications:

```go
// Example format:
//nolint:gosec // G304: path from checkpoint manager
//nolint:gosec // G115: line/col from parsed source are bounded
//nolint:gosec // G306: Hook needs exec permission
```

This ensures:
1. golangci-lint ignores these specific findings
2. Future developers understand why the suppression exists
3. The codebase passes lint checks without hiding issues
