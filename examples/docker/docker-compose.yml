# Copyright 2025 KrakLabs
# SPDX-License-Identifier: AGPL-3.0-or-later

# CIE Development Environment
# Local development environment for CIE - Code Intelligence Engine
#
# Usage:
#   docker compose up -d                    # Start services (Ollama + CIE Server)
#   docker compose --profile setup up       # First run: pull embedding model
#   docker compose --profile dev up -d      # Start with shell access
#   docker compose logs -f cie-server       # View CIE server logs
#   docker compose down                     # Stop services
#   docker compose down -v                  # Stop and remove all data
#
# After starting:
#   export CIE_BASE_URL=http://localhost:9090
#   cie init -y                             # Initialize project
#   cie index                               # Index repository

services:
  # ==========================================================================
  # Ollama - Local LLM for embeddings
  # ==========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: cie-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - cie-network
    restart: unless-stopped

  # ==========================================================================
  # Ollama Model Pull (run once with --profile setup)
  # ==========================================================================
  ollama-setup:
    image: curlimages/curl:latest
    container_name: cie-ollama-setup
    depends_on:
      ollama:
        condition: service_healthy
    networks:
      - cie-network
    command: >
      sh -c "
        echo 'Pulling nomic-embed-text model...' &&
        curl -X POST http://ollama:11434/api/pull -d '{\"name\": \"nomic-embed-text\"}' &&
        echo 'Model ready!'
      "
    profiles:
      - setup

  # ==========================================================================
  # CIE Server - HTTP API for code intelligence
  # ==========================================================================
  cie-server:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: dev
    image: cie:dev
    container_name: cie-server
    # Run as root to avoid permission issues with volumes
    user: "0:0"
    ports:
      - "9090:8080"
    volumes:
      # Mount repository for indexing (read-write for checkpoints and data)
      - .:/repo:rw
      # Persist CIE data between runs
      - cie-data:/data
    environment:
      OLLAMA_HOST: http://ollama:11434
      OLLAMA_EMBED_MODEL: nomic-embed-text
      CIE_DATA_DIR: /data
    depends_on:
      ollama:
        condition: service_healthy
    networks:
      - cie-network
    working_dir: /repo
    command: ["serve", "--port", "8080", "--project-id", "cie"]
    restart: unless-stopped

  # ==========================================================================
  # CIE CLI Tools (run with --profile tools)
  # ==========================================================================
  cie:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: dev
    image: cie:dev
    container_name: cie-dev
    volumes:
      # Mount repository for indexing (read-write for checkpoints and data)
      - .:/repo:rw
      # Persist CIE data between runs
      - cie-data:/home/cie/.cie
    environment:
      OLLAMA_HOST: http://ollama:11434
      OLLAMA_EMBED_MODEL: nomic-embed-text
    depends_on:
      ollama:
        condition: service_healthy
    networks:
      - cie-network
    working_dir: /repo
    # Default command shows status
    command: ["status"]
    profiles:
      - tools

  # ==========================================================================
  # CIE Shell (for interactive development)
  # ==========================================================================
  cie-shell:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    image: cie:dev-builder
    container_name: cie-shell
    volumes:
      - .:/repo
      - cie-data:/home/cie/.cie
    environment:
      OLLAMA_HOST: http://ollama:11434
      OLLAMA_EMBED_MODEL: nomic-embed-text
    depends_on:
      ollama:
        condition: service_healthy
    networks:
      - cie-network
    working_dir: /repo
    entrypoint: ["/bin/bash"]
    stdin_open: true
    tty: true
    profiles:
      - dev

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  ollama-data:
    name: cie-ollama-data
  cie-data:
    name: cie-dev-data

# ==========================================================================
# Networks
# ==========================================================================
networks:
  cie-network:
    name: cie-dev-network
    driver: bridge
